AWSTemplateFormatVersion: 2010-09-09
Description: >
  This template contains the necessary resources
  before deploying the Unit Test Builder pipeline.

Parameters:
  Developer:
    Type: String
    Description: Developer name
    Default: Luis

  PrefixName:
    Type: String
    Description: Prefix for the resources names
    Default: unit-test-builder

Resources:
#Roles required for deployment and execution
  #Role for CodeBuild
  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      Tags:
        - Key: desarrollador
          Value: !Ref Developer
      RoleName: !Sub ${PrefixName}-CodeBuild-Role
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: sts:AssumeRole
      Policies:
      #Allows send logs to CloudWatch
        - PolicyName: CodeBuild-CloudWatch-Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
        #Allows upload and download objects from S3
        - PolicyName: CodeBuild-S3-Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource: "*"
  #Role for CodePipeline
  CodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      Tags:
        - Key: desarrollador
          Value: !Ref Developer
      RoleName: !Sub ${PrefixName}-CodePipeline-Role
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: codepipeline.amazonaws.com
            Action: sts:AssumeRole
      Policies:
      #Allows pass roles to other services
        - PolicyName: CodePipeline-IAM-Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource: "*"
      #Allows upload and download objects from S3
        - PolicyName: CodePipeline-S3-Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                Resource: "*"
      #Allows perform the build phase
        - PolicyName: CodePipeline-CodeBuild-Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - codebuild:StartBuild
                  - codebuild:BatchGetBuilds
                Resource: "*"
      #Allows use a connection to retrieve resources
        - PolicyName: CodePipeline-CodeStar-Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - codestar-connections:UseConnection
                Resource: "*"
      #Allows manage resource stacks
        - PolicyName: CodePipeline-CloudFormation-Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - cloudformation:DescribeStacks
                  - cloudformation:CreateStack
                  - cloudformation:UpdateStack
                  - cloudformation:DescribeStackEvents
                Resource: "*"

  #Role for CloudFormation
  CloudFormationRole:
    Type: AWS::IAM::Role
    Properties:
      Tags:
        - Key: desarrollador
          Value: !Ref Developer
      RoleName: !Sub ${PrefixName}-CloudFormation-Role
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
            Action: sts:AssumeRole
      Policies:
      #Allows pass roles to other services
        - PolicyName: CloudFormation-IAM-Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource: "*"
      #Allows sending logs to CloudWatch
        - PolicyName: CloudFormation-CloudWatch-Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:PutRetentionPolicy
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
      #Allows manage the agent, its alias and guardrail in Bedrock
        - PolicyName: CloudFormation-Bedrock-Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:CreateGuardrailVersion
                  - bedrock:CreateGuardrail
                  - bedrock:UpdateGuardrail
                  - bedrock:GetGuardrail
                  - bedrock:DeleteGuardrail
                  - bedrock:CreateAgent
                  - bedrock:UpdateAgent
                  - bedrock:GetAgent
                  - bedrock:DeleteAgent
                  - bedrock:PrepareAgent
                  - bedrock:CreateAgentAlias
                  - bedrock:UpdateAgentAlias
                  - bedrock:GetAgentAlias
                  - bedrock:DeleteAgentAlias
                  - bedrock:TagResource
                  - bedrock:ListTagsForResource
                  - bedrock:ListAgentKnowledgeBases
                  - bedrock:ListAgentActionGroups
                Resource: "*"
      #Allows manage the API in APIGateway
        - PolicyName: CloudFormation-APIGateway-Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - apigateway:POST
                  - apigateway:GET
                  - apigateway:DELETE
                  - apigateway:TagResource
                Resource: "*"
      #Allows manage the function in Lambda
        - PolicyName: CloudFormation-Lambda-Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - lambda:CreateFunction
                  - lambda:DeleteFunction
                  - lambda:GetFunction
                  - lambda:TagResource
                  - lambda:AddPermission
                  - lambda:RemovePermission
                  - lambda:UpdateFunctionCode
                  - lambda:UpdateFunctionConfiguration
                Resource: "*"
        #Allows retrieve the function from S3
        - PolicyName: CloudFormation-S3-Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: "*"

  #Role for Lambda
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      Tags:
        - Key: desarrollador
          Value: !Ref Developer
      RoleName: !Sub ${PrefixName}-LambdaExecution-Role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
      #Allows sending logs to CloudWatch
        - PolicyName: Lambda-CloudWatch-Policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
      #Allows call the Bedrock Agent
        - PolicyName: Lambda-Bedrock-Policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeAgent
                  - bedrock:InvokeModel
                Resource: "*"

  #Role for Bedrock
  BedrockRole:
    Type: AWS::IAM::Role
    Properties:
      Tags:
        - Key: desarrollador
          Value: !Ref Developer
      RoleName: !Sub ${PrefixName}-Bedrock-Role
      Description: Unit Test Builder Agent
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: bedrock.amazonaws.com
            Action: sts:AssumeRole
      Policies:
      #Allows call the Bedrock Agent and apply the Guardrail
        - PolicyName: Bedrock-Bedrock-Policy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeAgent
                  - bedrock:InvokeModel
                  - bedrock:ApplyGuardrail
                Resource: "*"

#Bucket to store pipeline artifacts
  PipelineArtifactsBucket:
    Type: AWS::S3::Bucket
    Properties:
      Tags:
        - Key: desarrollador
          Value: !Ref Developer
      BucketName: !Sub ${PrefixName}-pipeline-artifacts-bucket

Outputs:
#Resource identifiers
  CodeBuildRole:
    Value: !GetAtt CodeBuildRole.Arn
    Export:
      Name: !Sub devops-${PrefixName}-codebuild-role

  CodePipelineRole:
    Value: !GetAtt CodePipelineRole.Arn
    Export:
      Name: !Sub devops-${PrefixName}-pipeline-role

  CloudFormationRole:
    Value: !GetAtt CloudFormationRole.Arn
    Export:
      Name: !Sub devops-${PrefixName}-cloudformation-role

  LambdaExecutionRole:
    Value: !GetAtt LambdaExecutionRole.Arn
    Export:
      Name: !Sub devops-${PrefixName}-lambda-role

  BedrockRole:
    Value: !GetAtt BedrockRole.Arn
    Export:
      Name: !Sub devops-${PrefixName}-bedrock-role

  PipelineArtifactsBucket:
    Value: !Ref PipelineArtifactsBucket
    Export:
      Name: !Sub devops-${PrefixName}-pipeline-artifacts-bucket
